# ğŸš€ All-in-One Task Scheduler Container
# Contains Kind + Helm + complete deployment for out-of-the-box experience
#
# Usage:
#   docker build -f deploy/docker/Dockerfile.all-in-one -t task-scheduler-aio .
#   docker run -it --privileged -p 3000:3000 -p 9090:9090 -p 50051:50051 task-scheduler-aio

FROM ubuntu:22.04

# Prevent interactive installation
ENV DEBIAN_FRONTEND=noninteractive
ENV TERM=xterm-256color

# Install basic tools
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    gnupg2 \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    lsb-release \
    systemd \
    systemd-sysv \
    dbus \
    sudo \
    vim \
    git \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Install Docker
RUN curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" \
    | tee /etc/apt/sources.list.d/docker.list > /dev/null \
    && apt-get update \
    && apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin \
    && rm -rf /var/lib/apt/lists/*

# Install kubectl
RUN curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg \
    && echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /' \
    | tee /etc/apt/sources.list.d/kubernetes.list \
    && apt-get update \
    && apt-get install -y kubectl \
    && rm -rf /var/lib/apt/lists/*

# Install Kind
RUN curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64 \
    && chmod +x ./kind \
    && mv ./kind /usr/local/bin/kind

# Install Helm
RUN curl https://baltocdn.com/helm/signing.asc | gpg --dearmor | tee /usr/share/keyrings/helm.gpg > /dev/null \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" \
    | tee /etc/apt/sources.list.d/helm-stable-debian.list \
    && apt-get update \
    && apt-get install -y helm \
    && rm -rf /var/lib/apt/lists/*

# Create working directory
WORKDIR /opt/task-scheduler

# Copy project files
COPY . .

# Create startup script
RUN cat > /usr/local/bin/start-task-scheduler.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸš€ å¯åŠ¨ Task Scheduler All-in-One å®¹å™¨"
echo "======================================"

# å¯åŠ¨ Docker daemon
echo "å¯åŠ¨ Docker æœåŠ¡..."
service docker start
sleep 5

# ç¡®ä¿ Docker æ­£åœ¨è¿è¡Œ
while ! docker info >/dev/null 2>&1; do
    echo "ç­‰å¾… Docker å¯åŠ¨..."
    sleep 2
done

echo "Docker å·²å¯åŠ¨ï¼"

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/task-scheduler

# è¿è¡Œä¸€é”®éƒ¨ç½²è„šæœ¬
echo "è¿è¡Œä¸€é”®éƒ¨ç½²..."
./scripts/deploy/deploy-one-click.sh kind

# è®¾ç½®ç«¯å£è½¬å‘ï¼ˆåå°è¿è¡Œï¼‰
echo "è®¾ç½®ç«¯å£è½¬å‘..."
kubectl port-forward svc/grafana 3000:3000 -n monitoring --address 0.0.0.0 &
kubectl port-forward svc/prometheus-kube-prometheus-prometheus 9090:9090 -n monitoring --address 0.0.0.0 &
kubectl port-forward svc/task-manager 50051:50051 -n task-scheduler --address 0.0.0.0 &

echo ""
echo "ğŸ‰ Task Scheduler å·²æˆåŠŸå¯åŠ¨ï¼"
echo ""
echo "ğŸ”— è®¿é—®åœ°å€ï¼š"
echo "  â€¢ Grafana: http://localhost:3000"
echo "  â€¢ Prometheus: http://localhost:9090"  
echo "  â€¢ gRPC API: localhost:50051"
echo ""
echo "ğŸ“‹ æœ‰ç”¨çš„å‘½ä»¤ï¼š"
echo "  â€¢ kubectl get pods -A                    # æŸ¥çœ‹æ‰€æœ‰ Pod"
echo "  â€¢ kubectl logs -f deploy/task-manager    # æŸ¥çœ‹ Manager æ—¥å¿—"
echo "  â€¢ ./scripts/test/benchmark.sh           # è¿è¡Œæ€§èƒ½æµ‹è¯•"
echo ""

# ä¿æŒå®¹å™¨è¿è¡Œ
echo "å®¹å™¨æ­£åœ¨è¿è¡Œ... æŒ‰ Ctrl+C é€€å‡º"
tail -f /dev/null
EOF

RUN chmod +x /usr/local/bin/start-task-scheduler.sh

# Expose ports
EXPOSE 3000 9090 50051 8080

# Startup script
CMD ["/usr/local/bin/start-task-scheduler.sh"]